## 不同主机的docker内容器通过直接路由的方式进行通信

- 主机1：
1. ip: 172.16.0.11
2. docker0: 10.0.128.1/24

- 主机2：
1. ip: 172.16.0.12
2. docker0: 10.0.129.1/24



- 在`/etc/docker/daemon.json`添加`bip`修改docker0的子网IP及其范围

172.16.0.11:
```json
{
        "registry-mirrors": ["https://registry.docker-cn.com","https://kxv08zer.mirror.aliyuncs.com"],
        "bip": "10.0.128.1/24"
}
```
172.16.0.12:
```json
{
        "registry-mirrors": ["https://registry.docker-cn.com","https://kxv08zer.mirror.aliyuncs.com"],
        "bip": "10.0.129.1/24"
}
```

- 添加新网络

主机：172.16.0.11，为容器指定网络和ip地址
```shell
docker network create --subnet=192.168.0.0/24 mynet
docker run -d -it --restart always --net mynet --ip 192.168.0.2 alpine
```

主机：172.16.0.12， 为容器指定网络和ip地址
```shell
docker network create --subnet=192.168.1.0/24 mynet2
docker run -d -it --restart always --net mynet2 --ip 192.168.1.2 alpine
```


- 在宿主机上修改路由规则；

```shell
# 主机11上操作
route add -net 192.168.1.0/24 gw 172.16.0.12

# 主机12上操作
route add -net 192.168.0.0/24 gw 172.16.0.11

```

- 保存路由

172.16.0.11

```shell
vi /etc/network/interfaces
up route add -net 192.168.1.0/24 gw 172.16.0.12 dev enp0s3
pre-up iptables-restore </etc/network/iptables.rules

```
172.16.0.12
```shell
vi /etc/network/interfaces
up route add -net 192.168.0.0/24 gw 172.16.0.11 dev enp0s3
pre-up iptables-restore </etc/network/iptables.rules
```

- 在宿主机上使用iptables添加NAT转发规则；

```shell
# 主机11
iptables -t nat -I PREROUTING -s 192.168.0.0/24 -d 192.168.1.0/24 -j DNAT --to 192.168.0.1

#主机12
iptables -t nat -I PREROUTING -s 192.168.1.0/24 -d 192.168.0.0/24 -j DNAT --to 192.168.1.1

```
保存iptables规则到文件：
iptables-save > /etc/network/iptables.rules

```shell
pre-up iptables-restore </etc/network/iptables.rules
```


- 在docker中ping测试连通性

```shell
docker exec -it c187e8a7ed80 ping 192.168.1.1
docker exec -it c187e8a7ed80 ping 192.168.1.2

docker exec -it 5dd1028522af ping 192.168.0.1
docker exec -it 5dd1028522af ping 192.168.0.2
docker exec -it 5dd1028522af ping www.baidu.com
```