### TCP建立的3次握手和断开的4次挥手

- 3次握手

  - 第一次握手: 客户端向服务器发起连接请求,发送SYN包(SYN=j)给服务器,客户端进入SYN_SENT状态等待服务器确认;
  - 第二次握手: 服务器收到SYN包后,必须确认客户端的SYN(ACK=j+1),所以向客户端发送一个SYN+ACK包(SYN=k),此时服务器进入SYN_RECV状态;
  - 第三次握手:客户端收到服务器的SYN+ACK包后,向服务器发送ACK包(ACK=k+1),此时客户端和服务器连接成功,都进入ESTABLISHED状态.

   ![image-20200303102037531](2020-3-2-TCP%E5%BB%BA%E7%AB%8B%E7%9A%843%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E6%96%AD%E5%BC%80%E7%9A%844%E6%AC%A1%E6%8C%A5%E6%89%8B.assets/image-20200303102037531.png)

- 4次挥手

  服务器端和客户端都可以发起断开连接的请求.以客户端发断开请求为例,说明4次挥手.

  - 第一次挥手: 客户端向服务器发送一个FIN报文,此时客户端进入等待服务器确认状态FIN_WAIT_1;
  - 第二次挥手: 服务器收到FIN报文后,确认是客户端发起的.服务器发送一个ACK包给客户端并关闭与客户端的连接,进入CLOSE_WAIT状态;
  - 第三次挥手: 客户端接到服务器发来的ACK报文后,进入FIN_WAIT_2状态,等服务器端继续发送FIN报文;
  - 第四次挥手: 客户端收到服务器的FIN报文后,最后发送ACK报文.两边断开连接.

   ![image-20200303102110669](2020-3-2-TCP%E5%BB%BA%E7%AB%8B%E7%9A%843%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E6%96%AD%E5%BC%80%E7%9A%844%E6%AC%A1%E6%8C%A5%E6%89%8B.assets/image-20200303102110669.png)

- 为什么建立连接需要3次,断开连接需要四次?

  - 建立连接的时候,服务器直接向客户端发送的SYN+ACK报文,其中ACK是响应的报文,SYN是同步的报文;
  - 关闭连接的时候,这个时候很可能服务器还在向客户端发送数据.所以客户端向服务器发送FIN报文的时候,服务器只告诉客户端我收到你的报文了,然后继续发送剩余的数据;等客户端收到ACK报文后,服务器再次发发送FIN报文请求断开,客户端这个时候才能断开连接.

